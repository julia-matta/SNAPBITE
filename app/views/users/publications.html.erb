<% content_for :title, "SnapBite - Meu Perfil" %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card-profile p-4 shadow-sm">
        <h2 class="card-title text-center mb-4">
          <%= current_user == @user ? "Meu Perfil" : "Perfil" %>
        </h2>

        <div class="text-center mb-4">
          <% if @user.profile_picture.attached? %>
            <%= image_tag url_for(@user.profile_picture), class: "rounded-circle border border-primary", style: "width: 150px; height: 150px; object-fit: cover;" %>
          <% else %>
            <%= image_tag "placeholder_profile.png", class: "rounded-circle border", style: "width: 150px; height: 150px; object-fit: cover;" %>
          <% end %>

          <p><strong>Usuário:</strong> <%= @user.username.presence || @user.email %></p>
          <p><strong>Tipo:</strong> <%= @user.owner? ? "Restaurante" : "Cliente" %></p>
        </div>

        <hr>

        <div class="text-center">
          <% if current_user == @user %>
            <%= link_to "Editar perfil", edit_user_path(@user), class: "btn btn-outline-secondary mt-3" %>
          <% else %>
            <% if current_user.following?(@user) %>
              <%= button_to "Deixar de seguir", friendship_path(@user), method: :delete, class: "btn btn-outline-danger mt-3" %>
            <% else %>
              <%= button_to "Seguir", friendships_path(friend_id: @user.id), method: :post, class: "btn btn-primary mt-3" %>
            <% end %>
          <% end %>

          <% tab_label =
            if @user.owner?
              "Meus restaurantes"
            else
              (current_user == @user ? "Minhas publicações" : "Publicações")
            end %>

          <ul class="nav nav-tabs mb-3 mt-4">
            <li class="nav-item">
              <%= link_to tab_label,
                publications_user_path(@user),
                class: "nav-link active" %>
            </li>

            <li class="nav-item">
              <%= link_to "Fotos", user_path(@user), class: "nav-link" %>
            </li>

            <li class="nav-item">
              <%= link_to "Seguidores", followers_user_path(@user), class: "nav-link" %>
            </li>

            <li class="nav-item">
              <%= link_to "Seguindo", following_user_path(@user), class: "nav-link" %>
            </li>
          </ul>

          <hr>
        </div>
      </div>
    </div>
  </div>
</div>

<% title_label =
  if @user.owner?
    "Meus restaurantes"
  else
    (current_user == @user ? "Minhas publicações" : "Publicações")
  end %>

<h3 class="profile-posts-title"><%= title_label %></h3>

<% if @posts.blank? %>
  <div class="profile-posts-section">
    <p class="text-muted">Ainda não há publicações.</p>
  </div>
<% else %>
  <div class="timeline-page">
    <div class="timeline-list">
      <% @posts.each do |post| %>
        <% user = post.user %>
        <% restaurant = post.restaurant %>

        <div class="feed-card">
          <div class="feed-card-header">
            <div class="feed-user">
              <% avatar =
                if user.profile_picture.attached?
                  url_for(user.profile_picture)
                else
                  asset_path("placeholder_profile.png")
                end %>

              <%= image_tag avatar, class: "feed-avatar" %>

              <div class="feed-user-text">
                <span class="feed-user-name"><%= user.username || user.email %></span>
                <% if post.caption.present? %>
                  <span class="feed-user-caption"><%= post.caption %></span>
                <% end %>
              </div>
            </div>

            <div class="feed-right">
              <% menu_times =
                if post.respond_to?(:menu_times) && post.menu_times.present?
                  post.menu_times
                elsif post.course.present?
                  [post.course.to_s.tr('[]"', '')]
                else
                  []
                end %>

              <% if menu_times.any? %>
                <span class="feed-pill">
                  <%= menu_times.map { |v| v.to_s.capitalize }.join(" • ") %>
                </span>
              <% end %>

              <% if current_user == @user %>
                <% is_owner_restaurant_post = current_user.owner? && restaurant.present? && restaurant.user_id == current_user.id %>
                <%= button_to (is_owner_restaurant_post ? restaurant_path(restaurant) : post_path(post)),
                      method: :delete,
                      data: { confirm: "Tem certeza que deseja excluir esta publicação?" },
                      class: "feed-delete-btn" do %>
                  <i class="fas fa-trash"></i>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- ✅ AQUI está a correção: usa restaurant.photo (upload) antes de image_name -->
          <div class="feed-photos">
            <% if post.photos.attached? %>
              <% post.photos.first(2).each do |photo| %>
                <a href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#postPhotosModal-<%= post.id %>">
                  <%= image_tag url_for(photo), class: "feed-photo" %>
                </a>
              <% end %>

            <% elsif restaurant&.photo&.attached? %>
              <a href="#"
                 data-bs-toggle="modal"
                 data-bs-target="#postPhotosModal-<%= post.id %>">
                <%= image_tag url_for(restaurant.photo), class: "feed-photo single" %>
              </a>

            <% elsif restaurant&.image_name.present? %>
              <a href="#"
                 data-bs-toggle="modal"
                 data-bs-target="#postPhotosModal-<%= post.id %>">
                <%= image_tag restaurant.image_name, class: "feed-photo single" %>
              </a>

            <% else %>
              <%= image_tag "placeholder.jpg", class: "feed-photo single" %>
            <% end %>
          </div>

          <% if restaurant %>
            <div class="feed-restaurant">
              <div>
                <h4 class="restaurant-name"><%= restaurant.name %></h4>
                <p class="restaurant-meta"><%= restaurant.category %></p>
              </div>

              <% if post.rating.present? %>
                <div class="feed-stars">
                  <% 5.times do |i| %>
                    <% if i < post.rating.to_i %>
                      <i class="fas fa-star"></i>
                    <% else %>
                      <i class="far fa-star"></i>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% user_reaction = post.post_reactions.detect { |r| r.user_id == current_user.id } %>
          <% reaction_type = user_reaction&.reaction_type %>

          <% btn_class =
              if reaction_type == "recommend"
                "btn-recommend btn-recommend--positive"
              elsif reaction_type == "not_recommend"
                "btn-recommend btn-recommend--negative"
              else
                "btn-recommend"
              end %>

          <div class="feed-footer">
            <div class="dropdown">
              <button
                type="button"
                class="<%= btn_class %>"
                data-bs-toggle="dropdown"
                aria-expanded="false">
                <% if reaction_type == "recommend" %>
                  <i class="far fa-thumbs-up"></i>
                  <span>Recomendo!</span>
                <% elsif reaction_type == "not_recommend" %>
                  <i class="far fa-thumbs-down"></i>
                  <span>Não recomendo</span>
                <% else %>
                  <i class="far fa-thumbs-up"></i>
                  <span>Recomendar</span>
                <% end %>
              </button>

              <ul class="dropdown-menu">
                <li>
                  <%= button_to "Recomendo!",
                        recommend_post_path(post),
                        method: :post,
                        class: "dropdown-item",
                        form: { class: "d-block" } %>
                </li>
                <li>
                  <%= button_to "Não recomendo",
                        not_recommend_post_path(post),
                        method: :post,
                        class: "dropdown-item",
                        form: { class: "d-block" } %>
                </li>

                <% if user_reaction.present? %>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= button_to "Remover reação",
                          reaction_post_path(post),
                          method: :delete,
                          class: "dropdown-item text-muted",
                          form: { class: "d-block" } %>
                  </li>
                <% end %>
              </ul>
            </div>

            <button
              class="feed-comments-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#comments-<%= post.id %>">
              <i class="far fa-comment"></i>
              <span><%= post.comments.count %></span>
            </button>
          </div>

          <div class="collapse mt-2" id="comments-<%= post.id %>">
            <div class="comments-list">
              <% post.comments.each do |comment| %>
                <p class="comment-item">
                  <strong><%= comment.user.username || comment.user.email %>:</strong>
                  <%= comment.content %>
                </p>
              <% end %>
            </div>

            <%= form_with(model: [post, Comment.new], local: true) do |f| %>
              <div class="input-group mt-2">
                <%= f.text_field :content,
                      class: "form-control",
                      placeholder: "Escreva um comentário..." %>
                <button class="btn btn-outline-secondary" type="submit">Enviar</button>
              </div>
            <% end %>
          </div>
        </div>

        <!-- ✅ Modal também com o mesmo fallback -->
        <div class="modal fade" id="postPhotosModal-<%= post.id %>" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-body p-0">
                <% if post.photos.attached? %>
                  <% post.photos.each do |photo| %>
                    <%= image_tag url_for(photo), class: "w-100 d-block modal-photo" %>
                  <% end %>
                <% elsif restaurant&.photo&.attached? %>
                  <%= image_tag url_for(restaurant.photo), class: "w-100 d-block modal-photo" %>
                <% elsif restaurant&.image_name.present? %>
                  <%= image_tag restaurant.image_name, class: "w-100 d-block modal-photo" %>
                <% else %>
                  <%= image_tag "placeholder.jpg", class: "w-100 d-block modal-photo" %>
                <% end %>
              </div>
            </div>
          </div>
        </div>

      <% end %>
    </div>
  </div>
<% end %>
