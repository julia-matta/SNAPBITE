<% content_for :title, "SnapBite - Seu perfil e publicações" %>

<div class="profile-page">
  <div class="profile-card">

    <h2 class="profile-title text-center mb-4">Meu Perfil</h2>

    <div class="profile-header text-center">
      <% if current_user.profile_picture.attached? %>
        <%= image_tag url_for(current_user.profile_picture),
              class: "profile-avatar" %>
      <% else %>
        <%= image_tag "placeholder_profile.png",
              class: "profile-avatar" %>
      <% end %>

      <p><strong>Usuário:</strong> <%= current_user.username || current_user.email %></p>
      <p><strong>Tipo:</strong> <%= current_user.owner? ? "Restaurante" : "Cliente" %></p>
    </div>

    <div class="text-center mb-3">
      <%= link_to "Editar perfil", edit_user_path(@user),
            class: "btn btn-outline-secondary btn-sm" %>
    </div>

    <hr>

    <% posts_tab_label = current_user.owner? ? "Meus restaurantes" : "Minhas publicações" %>

    <div class="profile-tabs-wrapper">
      <div class="profile-tabs-card">

        <%= link_to posts_tab_label,
              "#posts",
              class: "profile-tab-btn active" %>

        <%= link_to "Fotos",
              "#photos",
              class: "profile-tab-btn" %>

        <%= link_to "Seguidores",
              followers_user_path(@user),
              class: "profile-tab-btn followers" %>

        <%= link_to "Seguindo",
              following_user_path(@user),
              class: "profile-tab-btn following" %>

      </div>
    </div>

    <hr>

    <% @ratings_by_category.each do |category, ratings| %>
      <h4 class="profile-section-title"><%= category %></h4>

      <% ratings.group_by(&:restaurant).each do |restaurant, restaurant_ratings| %>
        <div class="profile-rating-card">
          <h5><%= restaurant.name %></h5>
          <ul>
            <% restaurant_ratings.each do |rating| %>
              <li>
                <strong><%= rating.score %>/5</strong>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <% end %>

    <hr>

    <h3 class="profile-posts-title" id="posts"><%= posts_tab_label %></h3>

    <div class="profile-posts-section">
      <% @posts.each do |post| %>
        <div class="profile-post-row">
          <div class="profile-post-main">
            <% if post.photos.attached? %>
              <%= image_tag post.photos.first, class: "profile-post-thumb" %>
            <% elsif post.restaurant&.photo&.attached? %>
              <%= image_tag url_for(post.restaurant.photo), class: "profile-post-thumb" %>
            <% elsif post.restaurant&.image_name.present? %>
              <%= image_tag post.restaurant.image_name, class: "profile-post-thumb" %>
            <% end %>

            <div class="profile-post-text">
              <strong><%= post.restaurant&.name || "Sem restaurante" %></strong>
              <p><%= post.caption %></p>
            </div>
          </div>

          <% is_owner_restaurant_post = current_user.owner? && post.restaurant.present? && post.restaurant.user_id == current_user.id %>
          <%= button_to "Excluir",
                (is_owner_restaurant_post ? restaurant_path(post.restaurant) : post_path(post)),
                method: :delete,
                data: { confirm: "Tem certeza que deseja excluir esta publicação?" },
                class: "profile-post-delete" %>
        </div>
      <% end %>
    </div>

  </div>
</div>
