<div class="container mt-4" style="max-width: 900px;">
  <div class="card p-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <strong><%= link_to (@post.user.username.presence || @post.user.email), user_path(@post.user), class: "text-decoration-none" %></strong>
        <% if @post.restaurant %>
          <span class="text-muted">— <%= @post.restaurant.name %></span>
        <% end %>
      </div>
      <small class="text-muted"><%= time_ago_in_words(@post.created_at) %> atrás</small>
    </div>

    <% if @post.photos.attached? %>
      <div class="mb-3">
        <% @post.photos.each do |photo| %>
          <%= image_tag photo, class: "w-100 d-block mb-2", style: "border-radius: 18px; object-fit: cover;" %>
        <% end %>
      </div>
    <% elsif @post.restaurant&.image_name.present? %>
      <%= image_tag @post.restaurant.image_name, class: "w-100 d-block mb-3", style: "border-radius: 18px; object-fit: cover;" %>
    <% end %>

    <p class="mb-3"><%= @post.caption %></p>

    <p class="mb-3"><%= @post.caption %></p>

    <% if @post.menu_times.present? %>
      <p class="text-muted mb-3"><%= @post.menu_times.join(" • ") %></p>
    <% end %>

    <hr>

    <% user_reaction = @post.post_reactions.detect { |r| r.user_id == current_user.id } %>
    <% reaction_type = user_reaction&.reaction_type %>
    <% negative = reaction_type == "not_recommend" %>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="dropdown">
        <button
          type="button"
          class="btn-recommend <%= negative ? 'btn-recommend--negative' : 'btn-recommend--positive' %>"
          data-bs-toggle="dropdown"
          aria-expanded="false">

          <% if negative %>
            <i class="far fa-thumbs-down"></i>
            <span>Não recomendo</span>
          <% elsif reaction_type == "recommend" %>
            <i class="far fa-thumbs-up"></i>
            <span>Recomendo!</span>
          <% else %>
            <i class="far fa-thumbs-up"></i>
            <span>Recomendar</span>
          <% end %>
        </button>

        <ul class="dropdown-menu">
          <li>
            <%= button_to "Recomendo!",
                  recommend_post_path(@post),
                  method: :post,
                  class: "dropdown-item",
                  form: { class: "d-block" } %>
          </li>
          <li>
            <%= button_to "Não recomendo",
                  not_recommend_post_path(@post),
                  method: :post,
                  class: "dropdown-item",
                  form: { class: "d-block" } %>
          </li>

          <% if user_reaction.present? %>
            <li><hr class="dropdown-divider"></li>
            <li>
              <%= button_to "Remover reação",
                    reaction_post_path(@post),
                    method: :delete,
                    class: "dropdown-item text-muted",
                    form: { class: "d-block" } %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>


    <h5>Comentários</h5>

    <div class="mb-3">
      <% @post.comments.each do |comment| %>
        <p class="mb-1">
          <strong><%= comment.user.username.presence || comment.user.email %>:</strong>
          <%= comment.content %>
        </p>
      <% end %>
    </div>

    <%= form_with(model: [@post, Comment.new], local: true) do |f| %>
      <div class="input-group">
        <%= f.text_field :content, class: "form-control", placeholder: "Escreva um comentário..." %>
        <button class="btn btn-outline-secondary" type="submit">Enviar</button>
      </div>
    <% end %>

    <div class="mt-3">
      <%= link_to "Voltar", user_path(@post.user), class: "btn btn-outline-secondary" %>
    </div>
  </div>
</div>
